<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,intitial-scale=1,maximum-scale=1">
    <script type="text/javascript" src="JS/jquery-1.12.2.min.js"></script>
    <script type="text/javascript" src="JS/fdb-all.min.js"></script>
    <script type="text/javascript" src="JS/bootstrap.min.js"></script>
    <link href="CSS/bootstrap.min.css" rel="stylesheet">
  </head>
  <body>
    <h1 style="text-align:center">支出查詢</h1>
    <input type="radio" name="month" value="thismonth" style="margin-left:5%">
    本月份
    <br>
    <input type="radio" name="month" value="months" style="margin-left:5%">
    指定月份
    <br>
    <input type="date" style="margin-left:5%">
    ~
    <input type="date">
    <button id="check" class="btn btn-primary" style="width:70%;margin-left:5%">查詢</button>
    <table class="table table-striped">
      <thead>
        <tr>
          <td>類別</td>
          <td>金額</td>
          <td>比例</td>
        </tr>
      </thead>
      <tbody id="type">
      </tbody>
    <h4 id="total">總計：</h4>
    </table>
        <table class="table table-striped">
      <thead>
        <tr>
          <td>日期</td>
          <td>事項</td>
          <td>金額</td>
        </tr>
      </thead>
      <tbody id="on">
      </tbody>
    </table>
    <a href="index.html"><button class="btn btn-success" style="margin-left:25%;width:50%">返回</button></a>
    <script>
      var fdb = new ForerunnerDB();
      var db = fdb.db("expenses");
      var expensesCollection = db.collection('expenses');
      var date = new Date();
      var year = date.getFullYear();
      var month = date.getMonth()+1;
      var date = date.getDate();
      if(month<10){
        month = "0"+month;
      }
      if(date<10){
        date = "0"+date;
      }
      console.log(year+"-"+month+"-01");
      expensesCollection.load(function(){
        $("#check").click(function(){
          var result = expensesCollection.find({
            time:{
              $gte: year+"-"+month+"-01",
              $lte: year+"-"+month+"-"+date
            }},
            {$orderBy:{time:-1}}
          );
          console.log(result);
          var type={
            食:0,
            衣:0,
            住:0,
            行:0,
            育:0,
            樂:0,
          }
          for(var i=0;i<result.length;i++){
            var thistype=result[i].type;
            type[thistype]=type[thistype]+result[i].money/1
          };
          var sum = type.食+type.衣+type.住+type.行+type.育+type.樂;
          $("#total *").remove();
          $("#total").append(
            "<tr><td>食</td><td>"+type.食+"<td></td>"+Math.floor(type.食*100/sum)+"%</td></tr>"+
            "<tr><td>衣</td><td>"+type.衣+"<td></td>"+Math.floor(type.衣*100/sum)+"%</td></tr>"+
            "<tr><td>住</td><td>"+type.住+"<td></td>"+Math.floor(type.住*100/sum)+"%</td></tr>"+
            "<tr><td>行</td><td>"+type.行+"<td></td>"+Math.floor(type.行*100/sum)+"%</td></tr>"+
            "<tr><td>育</td><td>"+type.育+"<td></td>"+Math.floor(type.育*100/sum)+"%</td></tr>"+
            "<tr><td>樂</td><td>"+type.樂+"<td></td>"+Math.floor(type.樂*100/sum)+"%</td></tr>");
          $("#on *").remove();
          for(var i=0;i<result.length;i++){
            $("#on").append(
              "<tr><td>"+result[i].time+
              "</td><td>"+result[i].thing+
              "</td><td>"+result[i].money+
              "</td></tr>"
            )
          };
        });
      });
    </script>
  </body>
</html>
