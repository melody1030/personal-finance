<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,intitial-scale=1,maximum-scale=1">
    <script type="text/javascript" src="JS/jquery-1.12.2.min.js"></script>
    <script type="text/javascript" src="JS/fdb-all.min.js"></script>
    <script type="text/javascript" src="JS/bootstrap.min.js"></script>
    <link href="CSS/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="CSS/main.css">
  </head>
  <body>
    <div class="non-semantic-protector"> 
      <h1 class="ribbon">
        <strong class="ribbon-content">支出查詢</strong>
      </h1>
    </div>
    <input type="radio" name="month" value="thismonth" style="margin-left:5%">
    本月份
    <br>
    <input type="radio" name="month" value="months" style="margin-left:5%">
    指定月份
    <br>
    <input type="date" style="margin-left:5%" id="start">
    ~
    <input type="date" id="end">
    <button id="check" class="btn btn-primary" style="width:70%;margin-left:15%">查詢</button>
    <table class="table table-striped" style="margin-left:5%">
      <thead>
        <tr>
          <td>類別</td>
          <td>金額</td>
          <td>比例</td>
        </tr>
      </thead>
      <tbody id="type">
      </tbody>
    </table>
        <table class="table table-striped" style="margin-left:5%">
      <thead>
        <tr>
          <td>日期</td>
          <td>事項</td>
          <td>金額</td>
        </tr>
      </thead>
      <tbody id="on">
      </tbody>
    </table>
    <button class="btn btn-danger" id="clear" style="margin-left:25%;margin-bottom:5%;width:50%">清除</button>
    <a href="index.html"><button class="btn btn-success" style="margin-left:25%;width:50%">返回</button></a>
    <script>
      var fdb = new ForerunnerDB();
      var db = fdb.db("expenses");
      var expensesCollection = db.collection('expenses');
      var date = new Date();
      var year = date.getFullYear();
      var month = date.getMonth()+1;
      var date = date.getDate();
      var select = "";
      var result = "";
      var startDate = "";
      var endDate = "";
      var sum = 0;
      var type = {};
      var thistype = "";
      if(month<10){
        month = "0"+month;
      }
      if(date<10){
        date = "0"+date;
      }
      console.log(year+"-"+month+"-01");
      expensesCollection.load(function(){
        $("#check").click(function(){
          select = $("input[name=month]:checked").val();
          console.log(select);
          startDate = $("#start").val();
          endDate = $("#end").val();
          if(select == "months" && !(startDate=="") && !(endDate=="")){
            result = expensesCollection.find({
              time:{
                $gte: startDate,
                $lte: endDate
              }},
              {$orderBy:{time:-1}}
            );
            console.log(startDate+" , "+endDate);
            console.log(result);
          }else if(select == "thismonth"){
            result = expensesCollection.find({
              time:{
                $gte: year+"-"+month+"-01",
                $lte: year+"-"+month+"-"+date
              }},
              {$orderBy:{time:-1}}
            );
            console.log(result);
          }else{
            alert("You didn't select the month!");
          }
          type={
            食:0,
            衣:0,
            住:0,
            行:0,
            育:0,
            樂:0,
          }
          for(var i=0;i<result.length;i++){
            thistype=result[i].type;
            type[thistype] += result[i].money/1
          };
          sum = type.食+type.衣+type.住+type.行+type.育+type.樂;
          $("#type *").remove();
          $("#type").append("<tr><td>食</td><td>"+type.食+"</td><td>"+Math.floor(type.食*100/sum)+"%</td></tr>");
          $("#type").append("<tr><td>衣</td><td>"+type.衣+"</td><td>"+Math.floor(type.衣*100/sum)+"%</td></tr>");
          $("#type").append("<tr><td>住</td><td>"+type.住+"</td><td>"+Math.floor(type.住*100/sum)+"%</td></tr>");
          $("#type").append("<tr><td>行</td><td>"+type.行+"</td><td>"+Math.floor(type.行*100/sum)+"%</td></tr>");
          $("#type").append("<tr><td>育</td><td>"+type.育+"</td><td>"+Math.floor(type.育*100/sum)+"%</td></tr>");
          $("#type").append("<tr><td>樂</td><td>"+type.樂+"</td><td>"+Math.floor(type.樂*100/sum)+"%</td></tr>");
          $("#on *").remove();
          for(var i=0;i<result.length;i++){
            $("#on").append(
              "<tr><td>"+result[i].time+
              "</td><td>"+result[i].thing+
              "</td><td>"+result[i].money+
              "</td></tr>"
            )
          };
        });
        $("#clear").click(function(){
          $("#type *").remove();
          $("#on *").remove();
          select = "";
          result = "";
          startDate = "";
          endDate = "";
          sum = 0;
          type = {};
          thistype = "";
        });
      });
    </script>
  </body>
</html>
